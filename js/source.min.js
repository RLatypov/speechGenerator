"use strict";angular.module("angular-websql",[]).factory("$webSql",["$q",function(e){return{openDatabase:function(t,r,n,a){try{var u=openDatabase(t,r,n,a);if("undefined"==typeof openDatabase)throw"Browser does not support web sql";return{executeQuery:function(t,r){var n=e.defer();return u.transaction(function(e){e.executeSql(t,r,function(e,t){n.resolve(t)},function(e,t){console.log("There has been an error: "+t.message),n.reject()})}),n.promise},insert:function(e,t,r){var n="boolean"==typeof r&&r?"INSERT OR REPLACE":"INSERT";n+=" INTO `{tableName}` ({fields}) VALUES({values});";var a="",u="",o=[];for(var i in t)a+=Object.keys(t)[Object.keys(t).length-1]==i?"`"+i+"`":"`"+i+"`, ",u+=Object.keys(t)[Object.keys(t).length-1]==i?"?":"?, ",o.push(t[i]);return this.executeQuery(this.replace(n,{"{tableName}":e,"{fields}":a,"{values}":u}),o)},update:function(e,t,r){var n="UPDATE `{tableName}` SET {update} WHERE {where}; ",a="",u=[];for(var o in t)a+=Object.keys(t)[Object.keys(t).length-1]==o?"`"+o+"`= ?":"`"+o+"`= ?,",u.push(t[o]);var i=this.whereClause(r);return this.executeQuery(this.replace(n,{"{tableName}":e,"{update}":a,"{where}":i.w}),u.concat(i.p))},del:function(e,t){var r="DELETE FROM `{tableName}` WHERE {where}; ",n=this.whereClause(t);return this.executeQuery(this.replace(r,{"{tableName}":e,"{where}":n.w}),n.p)},delAll:function(e){return this.executeQuery("DELETE FROM `"+e+"`; ")},select:function(e,t){var r="SELECT * FROM `{tableName}` WHERE {where}; ",n=this.whereClause(t);return this.executeQuery(this.replace(r,{"{tableName}":e,"{where}":n.w}),n.p)},selectAll:function(e){return this.executeQuery("SELECT * FROM `"+e+"`; ",[])},whereClause:function(e){var t="",r=[];for(var n in e)"undefined"==typeof e[n]||"object"==typeof e[n]||"string"!=typeof e[n]||e[n].match(/NULL/gi)?"undefined"!=typeof e[n]&&"object"!=typeof e[n]&&"number"==typeof e[n]?r.push(e[n]):"undefined"==typeof e[n].value||"object"!=typeof e[n]||"number"!=typeof e[n].value&&e[n].value.match(/NULL/gi)||r.push(e[n].value):r.push(e[n]),t+="object"==typeof e[n]?"undefined"==typeof e[n].union?"string"==typeof e[n].value&&e[n].value.match(/NULL/gi)?"`"+n+"` "+e[n].value:"undefined"!=typeof e[n].operator?"`"+n+"` "+e[n].operator+" ? ":"`"+n+"` = ?":"string"==typeof e[n].value&&e[n].value.match(/NULL/gi)?"`"+n+"` "+e[n].value+" "+e[n].union+" ":"undefined"!=typeof e[n].operator?"`"+n+"` "+e[n].operator+" ? "+e[n].union+" ":"`"+n+"` = ? "+e[n].union+" ":"string"==typeof e[n]&&e[n].match(/NULL/gi)?"`"+n+"` "+e[n]:"`"+n+"` = ?";return{w:t,p:r}},replace:function(e,t){for(var r in t)e=e.replace(new RegExp(r,"ig"),t[r]);return e},createTable:function(e,t){var r="CREATE TABLE IF NOT EXISTS `{tableName}` ({fields}); ",n=[],a="";for(var u in t){var o="{type} {null}";a+="`"+u+"` ","undefined"==typeof t[u]["null"]&&(t[u]["null"]="NULL");for(var i in t[u])o=o.replace(new RegExp("{"+i+"}","ig"),t[u][i]);a+=o,"undefined"!=typeof t[u]["default"]&&(a+=" DEFAULT "+t[u]["default"]),"undefined"!=typeof t[u].primary&&(a+=" PRIMARY KEY"),"undefined"!=typeof t[u].auto_increment&&(a+=" AUTOINCREMENT"),Object.keys(t)[Object.keys(t).length-1]!=u&&(a+=","),"undefined"!=typeof t[u].primary&&t[u].primary&&n.push(u)}var l={tableName:e,fields:a};for(var f in l)r=r.replace(new RegExp("{"+f+"}","ig"),l[f]);return this.executeQuery(r,[])},dropTable:function(e){return this.executeQuery("DROP TABLE IF EXISTS `"+e+"`; ",[])}}}catch(o){console.error(o)}}}}]);
"use strict";function getDataMainTemplate(a){var e=[];return angular.forEach(a.rows,function(a){var n=a.phrase.split("||"),t=[];angular.forEach(n,function(a){t.push({name:a})}),e.push({name:a.name,phrase:t})}),e}function dropTable(a,e){a.db.dropTable(e)}function openDataBase(a,e){a.db=e.openDatabase("SpeechGenerator","0.1","A list of phrases.",2e5),a.db||showModal("Ошибка","Не удалось подключиться к базе данных Web SQL.")}function addToDatabase(a){var e="phrases";a.db.selectAll(e).then(function(){a.db.delAll(e),insertToTable(a,e)},function(){a.db.createTable(e,{id:{type:"INTEGER","null":"NOT NULL",primary:!0,auto_increment:!0},name:{type:"TEXT","null":"NOT NULL"},phrase:{type:"TEXT","null":"NOT NULL"},created:{type:"TIMESTAMP","null":"NOT NULL","default":"CURRENT_TIMESTAMP"}}),insertToTable(a,e)})}function insertToTable(a,e){angular.forEach(a.phrases,function(n){var t="",r=n.name;angular.forEach(n.phrase,function(a){t+=a.name+"||"}),t=t.substring(0,t.length-2),a.db.insert(e,{name:r,phrase:t}).then(function(a){},function(){showModal("Ошибка","Не удалось добавить в базу данных.")})})}function disableEditMainTemplate(a){var e=$(".table-main-template");e.addClass("opacity").find("[contenteditable]").attr("contenteditable","false"),a.attr("disabled","true").next().removeAttr("disabled")}function isValidate(a){var e=!0,n="";return angular.forEach(a.phrases,function(a){angular.forEach(a.phrase,function(a){n+=a.name})}),n=n.toLowerCase(),angular.forEach(a.specifications,function(a){-1==n.indexOf("{{"+a.name+"}}".toLowerCase())&&(e=!1)}),e}function generation(a){var e="";angular.forEach(a.phrases,function(a){var n=randomNumber(a.phrase.length);e+=a.phrase[n].name+" "}),angular.forEach(a.specifications,function(a){e=e.replace("{{"+a.name+"}}",a.value)}),showModal("Фраза",e)}function randomNumber(a){return Math.floor(Math.random()*a)}function showModal(a,e){var n=$("#modal");n.find(".modal-body").text(e),n.find(".modal-title").text(a),n.modal("show")}
var speechGeneratorApp=angular.module("speechGeneratorApp",["angular-websql"]);speechGeneratorApp.directive("contenteditable",function(){return{restrict:"A",require:"ngModel",link:function(e,a,n,t){function m(){t.$setViewValue(a.html())}t.$render=function(){a.html(t.$viewValue||"")},a.bind("blur keyup change",function(){e.$apply(m)})}}}),speechGeneratorApp.controller("SpeechGenerator",["$scope","$webSql",function(e,a){openDataBase(e,a),e.db.selectAll("phrases").then(function(a){e.phrases=getDataMainTemplate(a)},function(){e.phrases=[{name:"Фраза 1",phrase:[{name:"Уважаемый(е) {{greeting}}"},{name:"Следует отметить что"},{name:"С другой стороны"},{name:"Для {{whom}}"},{name:"Прежде всего"},{name:"Не вызывает сомнений что"}]},{name:"Фраза 2",phrase:[{name:"социально-экономическое развитие"},{name:"выбранный нами {{choise}}"},{name:"повышение уровня гражданского сознания"},{name:"высокотехнологическая концепция общественной системы"},{name:"курс на {{way}}"},{name:"понимание сущности {{gist}}"}]},{name:"Фраза 3",phrase:[{name:"способствует повышению качества"},{name:"обеспечивает актуальность"},{name:"требует анализа"},{name:"напрямую зависит от"},{name:"создает предпосылки качественно новых шагов для"},{name:"играет важную роль в формировании"}]},{name:"Фраза 4",phrase:[{name:"поставленных обществом и правительством задач."},{name:"укрепления демократической системы."},{name:"новых принципов формирования материально-технической и кадровой базы."},{name:"прогресса профессионального сообщества."},{name:"поэтапного и последовательного развития общества."},{name:"экономической целесообразности принимаемых изменений."}]}]}),e.specifications=[{name:"greeting",value:"дамы и господа"},{name:"choise",value:"инновационный путь"},{name:"whom",value:"современного мира"},{name:"way",value:"социально-ориентированный проект"},{name:"gist",value:"ресурсосберегающих технологий"}],e.approveMainTemplate=function(){addToDatabase(e,a),disableEditMainTemplate(angular.element(event.target))},e.runGeneration=function(){isValidate(e)?generation(e):showModal("Ошибка","Есть расхождения уточнений с главным шаблоном")}}]);